# Simo L3 智能交互系统架构

## 概述

L3 级别的 Simo 将具备：
- **视觉感知** - 摄像头识别环境边界、家庭成员
- **自主导航** - 在家中自由移动，不出边界
- **智能对话** - 长对话、上下文记忆、家庭成员个性化
- **情感表达** - LED/屏幕表情、语音语调

## 系统架构

```
┌─────────────────────────────────────────────────────────────────┐
│                        用户交互层                                │
├─────────────────────────────────────────────────────────────────┤
│  语音输入 ──→ ASR ──→ │                    │ ──→ TTS ──→ 语音输出  │
│                       │   对话引擎 (LLM)   │                      │
│  触摸/手势 ─────────→ │                    │ ──→ 表情/LED         │
├─────────────────────────────────────────────────────────────────┤
│                        认知处理层                                │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐  ┌──────────┐        │
│  │ 意图理解 │  │ 记忆系统 │  │ 人脸识别 │  │ 场景理解 │        │
│  └──────────┘  └──────────┘  └──────────┘  └──────────┘        │
│                       │                                         │
│              ┌────────┴────────┐                               │
│              │   决策引擎      │                               │
│              └────────┬────────┘                               │
├─────────────────────────────────────────────────────────────────┤
│                        运动控制层                                │
├─────────────────────────────────────────────────────────────────┤
│  ┌──────────┐  ┌──────────┐  ┌──────────┐                      │
│  │ 路径规划 │  │ 避障控制 │  │ 边界检测 │                      │
│  └──────────┘  └──────────┘  └──────────┘                      │
│                       │                                         │
│              ┌────────┴────────┐                               │
│              │   STM32 小车    │                               │
│              └─────────────────┘                               │
└─────────────────────────────────────────────────────────────────┘
```

## 核心模块设计

### 1. 视觉边界系统

**目标**：让 Simo 知道哪里可以走，哪里不能走

**实现方案**：
```
方案A：地面标记识别
- 用彩色胶带在地上划定边界
- 摄像头识别胶带颜色
- 优点：简单可靠
- 缺点：需要物理标记

方案B：深度学习语义分割
- 训练模型识别"地面"vs"障碍物"
- 实时分割视频帧
- 优点：无需标记
- 缺点：需要训练数据、算力要求高

方案C：SLAM空间建图
- 首次运行时建立房间地图
- 后续根据地图导航
- 优点：精确、可复用
- 缺点：复杂度高

推荐：方案A（起步）+ 方案B（进阶）
```

**技术栈**：
- ESP32-S3 OV2640 摄像头
- OpenCV 图像处理
- TensorFlow Lite 边缘推理（可选）

### 2. 对话系统

**目标**：自然、有记忆、有个性的长对话

**架构**：
```
语音输入
    ↓
[语音识别 ASR]
    ↓
文本
    ↓
[意图识别] ──→ 运动指令 ──→ STM32
    ↓
[记忆检索] ──→ 相关上下文
    ↓
[LLM 对话] ──→ 回复文本
    ↓
[TTS 语音合成]
    ↓
语音输出
```

**记忆系统**：
```javascript
// 记忆结构
{
  "member_id": "dad",           // 家庭成员ID
  "memories": [
    {
      "content": "爸爸喜欢喝咖啡",
      "source": "explicit",     // 明确说的
      "confidence": 0.95,
      "timestamp": "2026-01-26"
    },
    {
      "content": "爸爸今天心情不太好",
      "source": "conversation", // 从对话推断
      "confidence": 0.6,
      "timestamp": "2026-01-26",
      "ttl": 86400             // 24小时后过期
    }
  ]
}
```

**对话特点**：
- 短回应优先（1-2句话）
- 敢说"不知道"
- 低存在感（不主动插话）
- 有情感但克制

### 3. 家庭成员识别

**目标**：认识家里每个人，个性化对待

**实现**：
```
注册流程：
1. "Simo，记住我，我是爸爸"
2. 拍摄多张人脸照片
3. 提取人脸特征向量
4. 存储到本地数据库

识别流程：
1. 摄像头检测人脸
2. 提取特征向量
3. 与数据库比对
4. 返回成员ID或"陌生人"
```

**技术栈**：
- ESP32-S3 人脸检测（ESP-WHO）
- 特征向量存储（PSRAM）
- 或上传到后端处理

### 4. 自主导航

**目标**：在家中自由移动，不碰撞、不出界

**状态机**：
```
[空闲] ──→ [巡逻] ──→ [检测障碍] ──→ [避障] ──→ [继续]
  ↑                        ↓
  └──────────────────── [停止]
                           ↑
                     "停" / 边界 / 危险
```

**安全规则**（BEHAVIOR.md 约束）：
- 传感器只有否决权
- STOP 永远抢占
- 不确定就不动
- 最终控制权属于人类

## 硬件需求

### 当前已有
- [x] ESP32-S3-N16R8（16MB Flash + 8MB PSRAM）
- [x] STM32 智能小车（电机 + 超声波 + 红外）

### 需要补充
- [ ] OV2640 摄像头模块（或 ESP32-S3-CAM）
- [ ] 麦克风模块（I2S INMP441）
- [ ] 扬声器模块（MAX98357A）
- [ ] WS2812B LED 灯带（表情）

### 可选升级
- [ ] 激光雷达（更精确的避障）
- [ ] ToF 深度传感器
- [ ] 屏幕（表情/状态显示）

## 开发路线图

### Phase 1：视觉基础（2周）
- [ ] ESP32-S3 摄像头图传
- [ ] 简单颜色识别（边界线）
- [ ] Web 实时视频流

### Phase 2：语音对话（2周）
- [ ] 语音识别集成（百度/讯飞）
- [ ] LLM 对话优化
- [ ] 语音合成优化

### Phase 3：人脸识别（1周）
- [ ] 人脸检测
- [ ] 家庭成员注册
- [ ] 身份识别

### Phase 4：自主导航（2周）
- [ ] 边界检测
- [ ] 路径规划
- [ ] 安全保护

### Phase 5：整合调试（1周）
- [ ] 全流程测试
- [ ] 性能优化
- [ ] 用户体验优化

## API 设计

### 对话 API
```javascript
POST /api/chat
{
  "member_id": "dad",        // 可选，识别到的成员
  "text": "今天天气怎么样",
  "context": []              // 上下文历史
}
→ {
  "reply": "今天北京晴天，最高温度8度。",
  "emotion": "neutral",
  "action": null
}
```

### 视觉 API
```javascript
GET /api/vision/stream      // 视频流
GET /api/vision/boundary    // 边界检测结果
POST /api/vision/face/register  // 注册人脸
GET /api/vision/face/identify   // 识别当前人脸
```

### 导航 API
```javascript
POST /api/nav/patrol        // 开始巡逻
POST /api/nav/goto          // 去某个位置
POST /api/nav/stop          // 停止
GET /api/nav/status         // 当前状态
```

## 注意事项

1. **安全第一**：所有运动指令必须过 BEHAVIOR.md 约束
2. **隐私保护**：人脸数据本地存储，不上传
3. **低功耗**：优化算法，延长续航
4. **可恢复**：任何时候都能手动控制

---

> 本文档随开发进展持续更新
> 最后更新：2026-01-26
