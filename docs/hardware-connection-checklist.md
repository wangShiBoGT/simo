# ESP32-S3 ↔ STM32 硬件连接检查清单

> 按顺序执行，每步独立验收，失败易定位
> 
> 最后更新：2026-01-26

---

## 🔌 Step 0: 供电与地线规划

### 接线

| 设备 | 供电方式 | 注意事项 |
|------|----------|----------|
| ESP32-S3 | 5V USB/Type-C | 独立供电 |
| STM32小车 | 电池/7.4V | 电机驱动板供电 |
| **GND** | **必须共地** | 串口通信稳定的前提 |

### ⚠️ 避免

- ❌ 电机供电反向给ESP32
- ❌ ESP32和电机走同一路5V
- ❌ 忽略共地

### ✅ 验收标准

- [ ] 两块板分别上电均正常运行
- [ ] ESP32控制页可打开 (http://192.168.4.1)
- [ ] STM32能单独跑原先固件

---

## 🔗 Step 1: 串口直连（最优先）

### 接线图

```
ESP32-S3                    STM32
┌─────────┐                ┌─────────┐
│ TX(43)  │───────────────►│ RX(PA10)│
│ RX(44)  │◄───────────────│ TX(PA9) │
│   GND   │◄──────────────►│   GND   │
└─────────┘                └─────────┘
```

### ⚠️ 关键检查

| 检查项 | 状态 | 说明 |
|--------|------|------|
| 电平确认 | □ | ESP32是3.3V TTL，STM32通常也是3.3V |
| 线材长度 | □ | 先用短杜邦线(<20cm) |
| 串口冲突 | □ | STM32是否同时接着USB-TTL？ |

### ✅ 验收测试

```bash
# 测试1: 停止命令
curl "http://192.168.0.109/cmd?c=S"
# 期望: STM32立即停止

# 测试2: 心跳
curl "http://192.168.0.109/ping"
# 期望: 返回 {"status":"ok","stm32":"connected"}

# 测试3: 压测脚本（100次循环）
node scripts/stress-test.js
```

- [ ] 发`S`(Stop)，STM32立即停
- [ ] 连续`F,200`/`S`循环100次无卡死
- [ ] 断开/重连ESP32，STM32不异常动作

---

## 📡 Step 2: 传感器回读验证

### 验证命令

```bash
# 读取传感器数据
curl "http://192.168.0.109/status"
# 期望: {"distance":xx,"ir_left":x,"ir_right":x}
```

### ✅ 验收测试

- [ ] 遮挡前方(<8cm)，系统拒绝前进或立即停机
- [ ] UI能看到距离值变化
- [ ] SafetyManager正确触发veto

---

## ⚙️ Step 3: 舵机/云台（可选）

> ⚠️ 如果仍有PWM抖动，先跳过此步

### 接线建议

- 舵机单独5V供电（足够电流）
- GND与主系统共地
- 信号线尽量短
- 必要时加电容(470µF~1000µF)

### ✅ 验收测试

- [ ] 舵机动作时串口不掉线
- [ ] 舵机动作时电机运动不受影响

---

## 📷 Step 4: 摄像头/麦克风（L3外设，最后接）

> 放到L2稳定后再接

| 外设 | 接口 | 注意事项 |
|------|------|----------|
| OV2640摄像头 | DVP/SPI | 驱动、带宽、帧率 |
| INMP441麦克风 | I2S | 时钟/中断/缓冲 |
| MAX98357A功放 | I2S | 实时性问题 |

---

## 🧪 快速排错指南

| 问题现象 | 可能原因 | 解决方案 |
|----------|----------|----------|
| 串口无响应 | 未共地 | 检查GND连接 |
| 数据乱码 | 波特率不匹配 | 确认都是115200 |
| 偶发丢包 | 线材过长/接触不良 | 换短杜邦线 |
| 命令延迟高 | 串口冲突 | 断开USB-TTL |
| 舵机动时串口断 | 供电噪声 | 舵机独立供电+加电容 |

---

## 📋 当前硬件信息（请填写）

```yaml
ESP32-S3:
  型号: ESP32-S3-DevKitC-1
  TX引脚: GPIO43
  RX引脚: GPIO44
  是否已占用: 否

STM32:
  型号: [填写]
  逻辑电平: 3.3V / 5V
  UART_RX: PA10
  UART_TX: PA9
  是否接着USB-TTL: [是/否]

供电:
  ESP32供电: USB
  STM32供电: [电池/电源]
  是否共地: [是/否]
```

---

## 🚀 一天内完成的最小清单

1. ✅ 共地、供电独立规划好
2. ✅ 串口三线（TX/RX/GND）接好
3. ✅ 连续压测：`F,200 → S` 循环100次
4. ✅ 用遮挡测试安全停机（传感器veto）
