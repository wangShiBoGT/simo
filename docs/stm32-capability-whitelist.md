# STM32 小车可用能力白名单（V1）

> **核心原则：凡是不在"允许"里的能力，一律不用。**

## 能力清单

| 类别 | 允许 | 禁止 | 说明 |
|------|------|------|------|
| 运动 | 前进 | 连续变速 | 只用固定 PWM |
| 运动 | 后退 | PID | 不做闭环 |
| 运动 | 左转 | 弧线转弯 | 只做原地转 |
| 运动 | 右转 | 自动恢复 | stop 最高优先级 |
| 运动 | 停止 | - | 任何时刻可调用，立即生效 |
| 感知 | 超声波 <20cm | 距离控制 | 只当危险信号，触发紧急停 |
| 跟随 | ❌ | 全部 | 禁用 |
| 避障 | ❌ | 全部 | 禁用（仅保留紧急停） |

## 原子动作定义

只允许以下 4 个动作：

```
move_forward(ms)   - 前进指定毫秒后自动停止
move_backward(ms)  - 后退指定毫秒后自动停止
turn_left(ms)      - 左转指定毫秒后自动停止
stop_now()         - 立即停止（最高优先级）
```

## 串口命令规范

| 命令 | 格式 | 响应 | 说明 |
|------|------|------|------|
| 前进 | `F,<ms>\n` | `OK,F,<ms>\r\n` | ms 到期自动停 |
| 后退 | `B,<ms>\n` | `OK,B,<ms>\r\n` | ms 到期自动停 |
| 左转 | `L,<ms>\n` | `OK,L,<ms>\r\n` | ms 到期自动停 |
| 右转 | `R,<ms>\n` | `OK,R,<ms>\r\n` | ms 到期自动停 |
| 停止 | `S\n` | `OK,S\r\n` | 立即生效 |
| 心跳 | `PING\n` | `PONG\r\n` | 连接检测 |

## PWM 设置

- **运动档**：85% PWM（固定，不可调）
- **停止档**：0% PWM

## 安全规则

1. 所有 `move_*` 函数内部必须在 ms 到期后调用 `stop_now()`
2. `stop_now()` 可被任何时刻调用，直接生效
3. 超声波 <20cm 时自动触发 `stop_now()`
4. 单次运动最长 3000ms，超过自动截断

## 稳定性测试标准

通过标准：**100 次连续控制，0 次失败**

测试序列：
```
前进 800ms → 停 → 后退 800ms
```

失败定义：
- 没动
- 停不下来
- 方向明显偏掉

---

## 稳定性测试结果

**测试日期**：2026-01-17  
**测试脚本**：`server/stability-test.cjs`

| 指标 | 结果 |
|------|------|
| 总测试轮数 | 100 |
| 成功次数 | 100 |
| 失败次数 | 0 |
| 成功率 | **100.0%** |

**测试序列**：
```
F,800 → OK,F,800 (前进800ms)
S → OK,S (停止)
B,800 → OK,B,800 (后退800ms)
```

**结论**：✅ 通过稳定性门槛，可进入 L2.5 阶段

---

## L2.5 意图层实现

**实现日期**：2026-01-17

### 架构

```
语音 → 文本
       ↓
  Intent Parser（意图层）  ← 本地规则优先
       ↓
  State Guard（状态机守卫）
       ↓
  Hardware Action（串口命令）
```

### 核心文件

| 文件 | 职责 |
|------|------|
| `server/intent/intent.schema.js` | Intent 数据结构定义 |
| `server/intent/intent.parser.js` | 自然语言→Intent 解析 |
| `server/intent/intent.guard.js` | 状态机守卫，决定是否执行 |

### API 接口

| 接口 | 方法 | 说明 |
|------|------|------|
| `/api/intent` | POST | 意图解析+执行 |
| `/api/intent/stop` | POST | 紧急停止 |
| `/api/intent/state` | GET | 查询机器人状态 |

### 守卫规则

1. **STOP 永远执行**（最高优先级）
2. **NONE 永远拒绝**（意图不明确）
3. **置信度 < 0.8 拒绝**
4. **移动中不接受新移动命令**（除了 STOP）

### 测试结果

- 30 句控制话语测试：**30/30 通过**
- STOP 命中率：**100%**
- 越权命令拒绝率：**100%**

---

## L2.6 确认层实现

**实现日期**：2026-01-17

### 架构

```
语音 → 文本
       ↓
  Intent Parser（意图层）
       ↓
  Intent Guard（L2.5 守卫）
       ↓
  Confirmation Layer（L2.6 确认层）  ← 新增
       ↓
  Hardware Action
```

### 核心文件

| 文件 | 职责 |
|------|------|
| `server/confirm/confirm.policy.js` | 确认策略（何时需要确认） |
| `server/confirm/confirm.prompt.js` | 确认提示模板 |
| `server/confirm/confirm.parse.js` | 确认回复解析 |
| `server/confirm/confirm.manager.js` | 确认状态机管理 |

### 确认规则

| 条件 | 动作 |
|------|------|
| STOP | 直接执行 |
| NONE | 拒绝 |
| MOVE & duration ≤ 800ms | 直接执行 |
| MOVE & duration > 800ms | 询问确认 |
| 置信度 [0.8, 0.85) | 询问确认 |
| 连续 TURN | 询问确认 |
| 刚 STOP 过 (< 1.5s) | 询问确认 |

### 确认回复解析

| 用户回复 | 判定 |
|----------|------|
| 是/对/好/执行/继续 | CONFIRM |
| 不/算了/停/别 | CANCEL |
| 其它 | IGNORE |

### 测试结果

- 10 个核心场景测试：**10/10 通过**
- STOP 抢占确认态：**100%**
- 超时自动取消：**正常**
- 无关回复忽略：**正常**

---

**版本**：V4  
**日期**：2026-01-17  
**状态**：✅ L2.6 确认层已实现
