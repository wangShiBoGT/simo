# 04 - 运动系统设计

> **运动系统是机器人的"腿"，决定了它能去哪里、怎么去。**

---

## 🎯 设计目标

1. **稳定**：不翻车、不打滑
2. **精准**：能按指令移动到位
3. **安全**：遇障碍能停止
4. **静音**：家用场景噪音要低

---

## 📊 底盘方案对比

### 一、常见底盘类型

| 类型 | 特点 | 适用场景 | 复杂度 |
|------|------|----------|--------|
| **差速轮** | 两轮驱动+万向轮 | 室内平地 | ⭐ |
| **四轮驱动** | 四轮独立驱动 | 室内/轻度越野 | ⭐⭐ |
| **麦克纳姆轮** | 全向移动 | 室内精确定位 | ⭐⭐⭐ |
| **履带式** | 越野能力强 | 户外/复杂地形 | ⭐⭐⭐ |

### 二、当前方案：四轮驱动

```
┌─────────────────────────────────┐
│         前进方向 ↑              │
│                                 │
│  ┌─────┐          ┌─────┐      │
│  │ M1  │          │ M2  │      │
│  │ ←   │          │   → │      │
│  └─────┘          └─────┘      │
│                                 │
│         ┌─────────┐            │
│         │ 底盘    │            │
│         └─────────┘            │
│                                 │
│  ┌─────┐          ┌─────┐      │
│  │ M3  │          │ M4  │      │
│  │ ←   │          │   → │      │
│  └─────┘          └─────┘      │
└─────────────────────────────────┘

运动控制：
- 前进：M1+M2+M3+M4 正转
- 后退：M1+M2+M3+M4 反转
- 左转：M1+M3 反转，M2+M4 正转
- 右转：M1+M3 正转，M2+M4 反转
```

**优点**：
- 结构简单
- 动力充足
- 成本低

**缺点**：
- 不能侧移
- 转向时有滑动

---

## ⚙️ 电机选型

### 当前使用：TT 马达

| 参数 | 规格 |
|------|------|
| 电压 | 3-6V |
| 空载转速 | 200rpm |
| 空载电流 | 150mA |
| 堵转电流 | 1.2A |
| 扭矩 | 0.8kg·cm |

**特点**：
- ✅ 便宜（¥5/个）
- ✅ 易于安装
- ❌ 精度低
- ❌ 无编码器

### 升级选项：带编码器电机

| 型号 | 电压 | 减速比 | 编码器 | 价格 |
|------|------|--------|--------|------|
| JGA25-370 | 12V | 1:34 | 11线 | ¥30 |
| GM25-370 | 12V | 1:34 | 11线 | ¥35 |
| N20 | 6V | 1:100 | 磁编码 | ¥25 |

**编码器的作用**：
- 精确测速
- 闭环控制
- 里程计算

---

## 🔧 电机驱动

### 当前使用：L298N

```
┌─────────────────────────────────┐
│  L298N 电机驱动板               │
│                                 │
│  VCC ──────── 电池正极          │
│  GND ──────── 电池负极/STM32 GND│
│  5V  ──────── 可给 STM32 供电   │
│                                 │
│  IN1 ──────── PA0 (STM32)       │
│  IN2 ──────── PA1               │
│  IN3 ──────── PA2               │
│  IN4 ──────── PA3               │
│                                 │
│  ENA ──────── PWM (速度控制)    │
│  ENB ──────── PWM (速度控制)    │
│                                 │
│  OUT1/OUT2 ── 电机 A            │
│  OUT3/OUT4 ── 电机 B            │
└─────────────────────────────────┘
```

**控制逻辑**：

| IN1 | IN2 | 电机A状态 |
|-----|-----|-----------|
| 0 | 0 | 停止 |
| 1 | 0 | 正转 |
| 0 | 1 | 反转 |
| 1 | 1 | 刹车 |

### 升级选项：TB6612

| 对比项 | L298N | TB6612 |
|--------|-------|--------|
| 效率 | 70% | 90% |
| 发热 | 大 | 小 |
| 体积 | 大 | 小 |
| 电流 | 2A | 1.2A |
| 价格 | ¥10 | ¥8 |

**推荐**：小电流场景用 TB6612，大电流场景用 L298N。

---

## 🎛️ 舵机系统

### 当前使用：SG90

| 参数 | 规格 |
|------|------|
| 电压 | 4.8-6V |
| 扭矩 | 1.8kg·cm |
| 角度 | 0-180° |
| 速度 | 0.1s/60° |

**用途**：超声波扫描（左右转动）

### 舵机控制

```
PWM 信号：
- 周期：20ms (50Hz)
- 脉宽：0.5ms → 0°
- 脉宽：1.5ms → 90°
- 脉宽：2.5ms → 180°
```

**STM32 控制代码**：
```c
// 设置舵机角度（0-180）
void Servo_SetAngle(uint8_t angle) {
    uint16_t pulse = 500 + angle * 2000 / 180;  // 500-2500us
    TIM_SetCompare1(TIM2, pulse);
}
```

### 舵机安装位置

```
        ┌─────────────────┐
        │   超声波模块    │
        │   HC-SR04       │
        └────────┬────────┘
                 │
        ┌────────┴────────┐
        │     舵机        │
        │     SG90        │
        └────────┬────────┘
                 │
        ─────────┴─────────
              底盘
```

---

## 📡 运动控制协议

### 串口命令格式

| 命令 | 格式 | 说明 | 响应 |
|------|------|------|------|
| 前进 | `F,800\n` | 前进800ms | `OK,F,800\r\n` |
| 后退 | `B,800\n` | 后退800ms | `OK,B,800\r\n` |
| 左转 | `L,300\n` | 左转300ms | `OK,L,300\r\n` |
| 右转 | `R,300\n` | 右转300ms | `OK,R,300\r\n` |
| 停止 | `S\n` | 立即停止 | `OK,S\r\n` |
| 舵机 | `SERVO,90\n` | 舵机转到90° | `OK,SERVO,90\r\n` |

### 速度控制

当前方案：**定时控制**
- 发送 `F,800` 表示前进 800ms
- 时间到自动停止

未来方案：**PWM 速度控制**
- 发送 `F,800,50` 表示前进 800ms，速度 50%
- 需要修改 STM32 固件

---

## 🤖 自主避障逻辑

### 当前实现

```
┌─────────────────────────────────────┐
│  自主避障循环（500ms 间隔）          │
│                                     │
│  1. 查询传感器                       │
│     └─→ SENSOR → D155,L0R0          │
│                                     │
│  2. 判断距离                         │
│     ├─ <15cm → 危险，后退           │
│     ├─ <30cm → 警戒，扫描           │
│     └─ >50cm → 安全，前进           │
│                                     │
│  3. 扫描决策                         │
│     ├─ 舵机转到 150°，测距          │
│     ├─ 舵机转到 90°，测距           │
│     ├─ 舵机转到 30°，测距           │
│     └─ 选择最远方向                  │
│                                     │
│  4. 执行动作                         │
│     ├─ 左边最远 → 左转              │
│     ├─ 右边最远 → 右转              │
│     └─ 前方最远 → 前进              │
└─────────────────────────────────────┘
```

### 配置参数

```javascript
const CONFIG = {
  DANGER_DISTANCE: 15,    // 危险距离 (cm)
  CAUTION_DISTANCE: 30,   // 警戒距离 (cm)
  SAFE_DISTANCE: 50,      // 安全距离 (cm)
  SERVO_LEFT: 150,        // 左扫角度
  SERVO_CENTER: 90,       // 中间角度
  SERVO_RIGHT: 30,        // 右扫角度
  SCAN_DELAY: 300,        // 扫描等待 (ms)
  MOVE_DURATION: 400,     // 移动时长 (ms)
  TURN_DURATION: 300,     // 转向时长 (ms)
  SCAN_INTERVAL: 500      // 循环间隔 (ms)
};
```

---

## 📈 升级路线

### 阶段 1：当前（已完成）

- ✅ 基础四轮驱动
- ✅ 定时控制
- ✅ 超声波避障
- ✅ 舵机扫描

### 阶段 2：精确控制

- 🔜 编码器电机
- 🔜 PID 速度控制
- 🔜 里程计

### 阶段 3：智能导航

- 🔜 SLAM 建图
- 🔜 路径规划
- 🔜 自动充电

---

## 🔗 相关文档

- [05-sensor-system.md](./05-sensor-system.md) - 传感器系统
- [../stm32-serial-protocol.md](../stm32-serial-protocol.md) - 串口协议
