# Simo 机器人启动流程设计

## 专业级启动序列

```
┌─────────────────────────────────────────────────────────────────┐
│                    SIMO 启动流程 (Boot Sequence)                 │
├─────────────────────────────────────────────────────────────────┤
│                                                                 │
│  ┌──────────┐    ┌──────────┐    ┌──────────┐    ┌──────────┐  │
│  │  Phase 0 │───→│  Phase 1 │───→│  Phase 2 │───→│  Phase 3 │  │
│  │  硬件自检 │    │  网络连接 │    │  服务启动 │    │  就绪待命 │  │
│  └──────────┘    └──────────┘    └──────────┘    └──────────┘  │
│       │               │               │               │         │
│       ▼               ▼               ▼               ▼         │
│   LED快闪        LED慢闪         LED常亮          LED呼吸       │
│   (自检中)      (连接中)        (启动中)         (已就绪)       │
│                                                                 │
└─────────────────────────────────────────────────────────────────┘
```

---

## Phase 0: 硬件自检 (Power-On Self Test)

**时长**: 2-5秒

### 检查项目
1. **内存检测** - ESP32 堆内存/PSRAM 可用性
2. **Flash检测** - NVS存储区完整性
3. **串口检测** - STM32通信链路 (PING/PONG)
4. **传感器检测** - 超声波/红外响应
5. **电池检测** - 电压/电量（如有）

### 自检结果
- ✅ 全部通过 → 进入 Phase 1
- ⚠️ 部分失败 → 降级模式运行
- ❌ 关键失败 → LED红闪 + 错误码

### LED指示
- 快闪蓝色 = 自检进行中
- 闪绿色 = 检测通过
- 闪红色 = 检测失败

---

## Phase 1: 网络连接

**时长**: 5-30秒

### 1.1 检查已保存的WiFi凭证
```
NVS存储 → 读取 SSID/Password
  ├─ 有凭证 → 尝试连接家庭WiFi
  └─ 无凭证 → 进入配网模式
```

### 1.2 WiFi连接策略
```
家庭WiFi连接:
  ├─ 成功 → 进入 Phase 2
  ├─ 失败(3次) → 启动AP配网模式
  └─ 超时(30s) → 启动AP配网模式
```

### 1.3 Captive Portal 配网
```
用户操作:
1. 手机连接 "Simo-Setup" 热点
2. 自动弹出配网页面 (Captive Portal)
3. 选择家庭WiFi + 输入密码
4. 保存到NVS → 重启连接
```

### LED指示
- 慢闪蓝色 = 正在连接
- 快闪蓝色 = 配网模式
- 常亮蓝色 = 已连接

---

## Phase 2: 服务启动

**时长**: 3-10秒

### 启动顺序
1. **NTP时间同步** - 获取准确时间
2. **OTA检查** - 连接服务器检查更新
3. **后端连接** - 连接Simo后端API
4. **MQTT连接** - 建立实时通信通道（可选）

### OTA更新策略
```
服务器推送模式:
1. ESP32 启动时检查服务器版本
2. 有新版本 → 下载并安装
3. 安装成功 → 自动重启
4. 安装失败 → 回滚到旧版本
```

### LED指示
- 常亮蓝色 = 服务启动中
- 闪紫色 = OTA更新中

---

## Phase 3: 就绪待命

**系统状态**: 完全就绪

### 功能可用
- ✅ Web控制面板
- ✅ 语音命令
- ✅ 自主导航
- ✅ 远程OTA更新
- ✅ 数据上报

### LED指示
- 呼吸蓝色 = 空闲待命
- 呼吸绿色 = 自主模式
- 常亮黄色 = 执行任务中
- 闪红色 = 紧急停止

---

## 硬件扩展规划

### 必备硬件清单

| 硬件 | 用途 | 优先级 | 预算 |
|------|------|--------|------|
| **OV2640摄像头** | 视觉感知 | ⭐⭐⭐ | ¥15-30 |
| **SG90舵机** | 摄像头云台 | ⭐⭐⭐ | ¥5-10 |
| **I2S麦克风** | 语音输入 | ⭐⭐⭐ | ¥10-20 |
| **I2S功放+喇叭** | 语音输出 | ⭐⭐⭐ | ¥15-25 |
| **18650电池组** | 独立供电 | ⭐⭐ | ¥30-50 |
| **电池管理模块** | 充放电控制 | ⭐⭐ | ¥10-15 |
| **0.96" OLED** | 状态显示/表情 | ⭐⭐ | ¥10-15 |

### 摄像头云台设计
```
        ┌─────────┐
        │ OV2640  │  ← 摄像头
        │ Camera  │
        └────┬────┘
             │
        ┌────┴────┐
        │  舵机1   │  ← 左右转动 (Yaw)
        │ (水平)  │
        └────┬────┘
             │
        ┌────┴────┐
        │  舵机2   │  ← 上下转动 (Pitch)
        │ (垂直)  │
        └────┬────┘
             │
        ┌────┴────┐
        │ 小车底盘 │
        └─────────┘
```

### 独立供电方案
```
┌─────────────────────────────────────────┐
│              电源管理系统                │
├─────────────────────────────────────────┤
│                                         │
│  ┌─────────┐    ┌─────────┐            │
│  │18650×2  │───→│ BMS模块 │            │
│  │ 电池组  │    │充放电保护│            │
│  └─────────┘    └────┬────┘            │
│                      │                  │
│         ┌───────────┴───────────┐      │
│         │                       │      │
│    ┌────▼────┐            ┌────▼────┐  │
│    │  5V降压  │            │ 3.3V降压│  │
│    │ (STM32) │            │(ESP32)  │  │
│    └─────────┘            └─────────┘  │
│                                         │
└─────────────────────────────────────────┘
```

---

## OTA服务器推送架构

### 推荐方案: 自建OTA服务器

```
┌─────────────────────────────────────────────────────────────┐
│                     OTA 更新流程                            │
├─────────────────────────────────────────────────────────────┤
│                                                             │
│  开发者                    服务器                   机器人  │
│    │                         │                        │     │
│    │  1. 上传新固件           │                        │     │
│    │─────────────────────────→│                        │     │
│    │                         │                        │     │
│    │                         │  2. 检查版本(启动时)    │     │
│    │                         │←───────────────────────│     │
│    │                         │                        │     │
│    │                         │  3. 返回新版本信息      │     │
│    │                         │───────────────────────→│     │
│    │                         │                        │     │
│    │                         │  4. 下载固件           │     │
│    │                         │←───────────────────────│     │
│    │                         │                        │     │
│    │                         │  5. 安装并重启         │     │
│    │                         │                        │     │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

### 服务器API设计
```
GET /api/ota/check?device=simo&version=2.2.0
Response: {
  "update_available": true,
  "latest_version": "2.3.0",
  "download_url": "/firmware/simo-2.3.0.bin",
  "changelog": "新增摄像头支持"
}

GET /firmware/simo-2.3.0.bin
Response: 固件二进制文件
```

---

## 完整硬件采购清单

### 第一批（基础功能）
- [ ] OV2640摄像头模块 × 1
- [ ] SG90舵机 × 2 (云台)
- [ ] 杜邦线 若干

### 第二批（语音交互）
- [ ] INMP441 I2S麦克风 × 1
- [ ] MAX98357A I2S功放 × 1
- [ ] 3W喇叭 × 1

### 第三批（独立供电）
- [ ] 18650电池 × 2
- [ ] 2S BMS保护板 × 1
- [ ] DC-DC降压模块 × 2 (5V + 3.3V)
- [ ] 电池座 × 1

### 第四批（显示交互）
- [ ] 0.96寸 I2C OLED × 1
- [ ] WS2812 LED灯带 × 1 (表情灯)

---

## 下一步开发计划

1. **WiFi Captive Portal** - 手机配网自动弹窗
2. **NVS凭证存储** - 记住WiFi密码
3. **完整启动流程** - Phase 0-3 实现
4. **OTA服务器检查** - 启动时自动检查更新
5. **摄像头模块** - 视觉功能框架
6. **舵机云台** - PWM控制舵机
